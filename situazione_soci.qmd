---
title: |
  Situazione Soci
subtitle: |
  Analisi della composizione sociale
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 6,
  fig.height = 5,
  fig.align = "center",
  out.width = "100%",
  dpi = 300
)
library(tidyverse)
library(stringr)
library(tmap)
library(sf)
library(glue)
source("wj_utils.R")
source("winddoc_tokens.R")

wj_list_associates_lazy <- memoise::memoise(
  wj_list_associates, 
  cache = cachem::cache_disk(max_age = 3600*24, dir="cache"))

raw_data <- wj_list_associates_lazy(tokens)
province <- read_tsv("province.txt", na=c("")) 
```

```{r}
data <- raw_data %>% 
  select(
    nome, cognome, codice_fiscale, data_iscrizione, 
    data_nascita = contatto_data_nascita,
    contatto_indirizzo_citta, contatto_indirizzo_cap,
    contatto_indirizzo_provincia, contatto_indirizzo_nazione,
    data_iscrizione, data_scadenza_quota, deve_rinnovare
  ) %>% 
  rename_with(
    ~ str_replace_all(.x, "contatto_indirizzo_", ""),
    everything()
  )

soci <- data %>% 
  mutate(
    età = interval(ymd(data_nascita), today()) %/% years(1),
    provincia = str_to_upper(provincia) %>% 
      str_replace_all("[\\s]+$", "") %>% 
      str_replace_all("[\\s]", "-")
  ) %>% 
  relocate(età, .after = data_nascita) %>%
  left_join(
    province, 
    by = c("provincia" = "PROVINCIA")
  ) %>% 
  # relocate(SIGLA, .after=provincia) %>% 
  mutate(
    provincia = ifelse(is.na(SIGLA), provincia, SIGLA),
    citta = str_to_title(citta),
    genere_n = str_sub(codice_fiscale, 10, 11) %>% as.numeric(),
    genere = ifelse(genere_n>30, "F", "M")
  ) %>% 
  select(-c(SIGLA, REGIONE, genere_n)) %>% 
  relocate(genere, .after=età)

N <- nrow(soci)
```


## Sorgente dati

* I dati qui riportati sono stati estratti il **`r Sys.Date()`**
* Il libro soci attualmente contiene **`r N`** elementi


## Posizione sociale

Risultano iscritti **`r N`** soci con le seguenti posizioni associative:

```{r}
soci %>% 
  group_by(Stato = deve_rinnovare) %>% 
  summarise(Numero = n()) %>% 
  arrange(desc(Numero)) %>% 
  mutate(Stato = ifelse(Stato, "Deve rinnovare", "In regola")) %>%
  knitr::kable()
```




## Numerosità per provincia

* Su `r N` soci, `r filter(soci, nazione == "IT") %>% nrow()` sono in Italia
* A livello nazionale, i soci sono distribuiti in `r length(unique(soci$provincia))` province, di cui:

:::{.columns}
:::{.column width="50%"}

```{r}
soci_n <- soci %>% 
  group_by(Provincia = provincia, genere) %>% 
  summarise(
    Numero = n()) %>% 
  pivot_wider(
    names_from = genere, 
    values_from = Numero
  ) %>%
  mutate(Totale = sum(M, F, na.rm=TRUE)) %>%
  arrange(desc(Totale))

soci_n %>% 
  filter(Totale > 5) %>% 
  knitr::kable()
```
:::

:::{.column width="50%"}
```{r}
#| echo: false
#| fig.width: 4
#| fig.height: 5
#| fig.align: "center"
#| out.width: "75%"
shapefile <-  "maps/georef-italy-provincia-millesime.shp"
italy <- read_sf(shapefile)
# italy <- rmapshaper::ms_simplify(italy, keep=0.1)

map <- italy %>% 
  left_join(soci_n, by = c("prov_sigla" = "Provincia")) %>%
  tm_shape(simplify=0.05) + 
  tm_borders() +
  tm_fill(
    col = "Totale", 
    style = "jenks", 
    title = "Numero soci WJ", 
    textNA="Nessuno", 
    legend.format=list(text.separator = "-")
  )
tmap_mode("plot")
map
```
:::
:::

## Distribuzione di età

:::{.columns}

:::{.column width="50%"}
In quantili, la distribuzione di età dei soci è la seguente:
```{r}
quantile(soci$età, na.rm = TRUE) %>% broom::tidy() %>% 
  rename(
    Quantile = names,
    Età = x
  ) %>% 
  knitr::kable()
```

:::

:::{.column width="50%"}
```{r}
soci %>% {
    ggplot(., aes(x = età)) +
    geom_histogram(binwidth = 5, fill = "steelblue", color = "black") +
    geom_vline(xintercept = mean(.$età, na.rm = TRUE), linetype = "dashed", color = "red") +
    geom_vline(xintercept = median(.$età, na.rm = TRUE), linetype = "dashed", color = "green") +
    scale_x_continuous(breaks = seq(0, 100, 5)) +
    labs(y="Conteggio", title=glue("Distribuzione età soci: Media: {round(mean(.$età, na.rm = TRUE), 1)} anni, Mediana: {round(median(.$età, na.rm = TRUE), 1)} anni"))
  }
```
:::
:::


## Distribuzione per genere

::: columns
:::{.column width="50%"}
```{r}
soci %>%
  group_by(Genere = genere) %>%
  summarise(
    Numero = n(),
    `Età` = mean(età, na.rm = TRUE) %>% round(1),
    eta_min = min(età, na.rm = TRUE),
    eta_max = max(età, na.rm = TRUE)
  ) %>% 
  mutate(
    `Età` = glue("{Età} ({eta_min}-{eta_max})")
  ) %>%
  select(-c(eta_min, eta_max)) %>%
  knitr::kable()
  
```
:::

:::{.column width="50%"}
```{r}
#| echo: false
#| fig.width: 4
#| fig.height: 5
#| fig.align: "center"
#| out.width: "75%"
map <- italy %>% 
  left_join(
    mutate(soci_n, Prevalenza=ifelse(M>F, "maschi", "femmine")), 
    by = c("prov_sigla" = "Provincia")) %>%
  tm_shape(simplify=0.05) + 
  tm_borders() +
  tm_fill(
    col = "Prevalenza", 
    style = "jenks", 
    title = "Prevalenza genere", 
    textNA="Nessuno", 
    legend.format=list(text.separator = "-")
  )
tmap_mode("plot")
map
```
:::
:::



```{r}
storico <- soci %>% 
  arrange(data_iscrizione) %>% 
  mutate(
    week = format(ymd(data_iscrizione), "%Y-%V"),
    .after = 1
  ) %>% 
  group_by(week) %>%
  summarise(
    Data = last(data_iscrizione) %>% ymd(),
    Soci = n(),
    `Soci in regola` = sum(!deve_rinnovare),
    `Soci da rinnovare` = sum(deve_rinnovare),
    Maschi = sum(genere == "M", na.rm = TRUE),
    Femmine = sum(genere == "F", na.rm = TRUE),
    `Soci in Italia` = sum(nazione == "IT", na.rm = TRUE),
    `Soci all'estero` = sum(nazione != "IT", na.rm = TRUE)
  ) %>% 
  mutate(
    across(-c(week, Data), cumsum)
  )
```



```{r}
prov_count <- soci %>% 
  filter(!is.na(provincia)) %>% 
  arrange(data_iscrizione) %>% 
  mutate(
    week = format(ymd(data_iscrizione), "%Y-%V"),
    .after = 1
  ) %>% 
  group_by(week, provincia) %>% 
  select(provincia, week, data_iscrizione) %>% 
  summarise(
    Numero = n()
  ) %>% 
  pivot_wider(
    names_from = provincia, 
    names_prefix = "prov_",
    values_from = Numero
  ) %>% 
  ungroup() %>% 
  mutate(
    across(2:last_col(), ~replace_na(., 0))
  ) %>%
  mutate(across(2:last_col(), cumsum))

storico %>% 
  left_join(prov_count) %>% 
  select(-week) %>% 
  write_csv("storico.csv", col_names=TRUE, append=FALSE)
```



